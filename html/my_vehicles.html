<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vehicles - MyRTO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            height: 32px;
            width: 32px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .logo-text {
            color: white;
            font-size: 1.75rem;
            font-weight: 700;
        }

        /* Styles for Status & Validity Badges */
        .status {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .validity-active {
            color: #28a745;
        }

        .validity-expired {
            color: #dc3545;
        }

        /* --- STYLES ADDED FROM DASHBOARD --- */

        /* Smooth Dropdown Animation */
        .dropdown-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out, margin-top 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            margin-top: 0 !important;
        }

        details[open]>.dropdown-content {
            max-height: 400px;
            /* Adjust as needed */
            opacity: 1;
            margin-top: 0.25rem !important;
            /* Tailwind 'mt-1' */
        }
    </style>
</head>

<body class="h-full">

    <div class="flex h-screen">

        <aside class="w-64 flex flex-col bg-indigo-800 text-indigo-100 shadow-xl">
            <div class="p-6">
                <div class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                        </path>
                    </svg>
                    <span class="logo-text">MyRTO</span>
                </div>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="dashboard.html"
                    class="flex items-center space-x-3 px-3 py-2 rounded-lg text-indigo-200 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                    </svg>
                    <span class="font-medium">Dashboard</span>
                </a>

                <details class="group" open>
                    <summary
                        class="flex items-center justify-between space-x-3 px-3 py-2 rounded-lg hover:bg-indigo-700 cursor-pointer transition-colors duration-200">
                        <div class="flex items-center space-x-3">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="font-medium">Services</span>
                        </div>
                        <svg class="h-5 w-5 transform group-open:rotate-90 transition-transform duration-200"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </summary>

                    <div class="mt-2 space-y-1 pl-9">
                        <details>
                            <summary
                                class="flex items-center justify-between px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white cursor-pointer transition-colors duration-200">
                                <span>License Services</span>
                                <svg class="h-5 w-5 transform open:rotate-90 transition-transform duration-200"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                </svg>
                            </summary>
                            <div class="mt-1 space-y-1 pl-4 dropdown-content">
                                <a href="llform.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Apply
                                    for learner's license</a>
                                <a href="profile.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Check
                                    Licence status</a>
                            </div>
                        </details>

                        <details open>
                            <summary
                                class="flex items-center justify-between px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white cursor-pointer transition-colors duration-200">
                                <span>Vehicle Services</span>
                                <svg class="h-5 w-5 transform open:rotate-90 transition-transform duration-200"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                </svg>
                            </summary>
                            <div class="mt-1 space-y-1 pl-4 dropdown-content">
                                <a href="vehiclereg.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">New
                                    vehicle registration</a>
                                <a href="renewal.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Renewal
                                    of registration</a>
                                <a href="transfer.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Transfer
                                    of ownership</a>
                                <a href="my_vehicles.html"
                                    class="block px-3 py-2 rounded-md text-white bg-indigo-700 transition-colors duration-200 text-sm font-medium"
                                    aria-current="page">Check
                                    vehicle details</a>
                            </div>
                        </details>
                  
                    </div>
                </details>

                <a href="dashboard.html#applications"
                    class="flex items-center space-x-3 px-3 py-2 rounded-lg text-indigo-200 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
                    </svg>
                    <span class="font-medium">My Applications</span>
                </a>
                <a href="my_payments.html"
                    class="flex items-center space-x-3 px-3 py-2 rounded-lg text-indigo-200 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                    <span class="font-medium">My Payments</span>
                </a>
            </nav>

            <div class="mt-auto p-4">
                <div class="flex items-center justify-between p-3 bg-indigo-700 rounded-lg">
                    <div>
                        <p class="text-sm">Welcome,</p>
                        <p id="user-name" class="font-medium text-white">User</p>
                    </div>
                    <button id="logout-button"
                        class="p-2 rounded-md text-indigo-200 hover:bg-red-500 hover:text-white transition-all duration-300 ease-in-out"
                        title="Log Out">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <div class="max-w-7xl mx-auto py-10 sm:px-6 lg:px-8">

                <div class="mb-6 px-4 sm:px-0">
                    <h1 class="text-3xl font-bold text-gray-900">My Vehicles</h1>
                </div>

                <div class="mb-6 px-4 sm:px-0">
                    <div class="flex flex-col md:flex-row gap-4 justify-between">

                        <div class="relative flex-grow md:w-1/2">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="searchInput"
                                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="Search by registration number...">
                        </div>

                        <div class="flex-shrink-0">
                            <select id="sortSelect"
                                class="block w-full md:w-auto pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="default">Sort by...</option>
                                <option value="reg_expiring">Registration Expiring Soon</option>
                                <option value="ins_expiring">Insurance Expiring Soon</option>
                            </select>
                        </div>
                    </div>
                </div>
                <p id="loadingMessage" class="mt-2 text-gray-600 px-4 sm:px-0">Loading your vehicle details...</p>

                <div id="vehicleGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 px-4 sm:px-0">
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- 1. Get references to DOM elements ---
        const loadingMsg = document.getElementById("loadingMessage");
        const grid = document.getElementById("vehicleGrid");
        const searchInput = document.getElementById("searchInput");
        const sortSelect = document.getElementById("sortSelect");

        // --- 2. Helper: Debounce Function ---
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- 3. User & Auth (Copied from Dashboard) ---
            let userFullName = 'User';
            let userId = null;
            let userData = null;

            try {
                userData = JSON.parse(localStorage.getItem('myRtoUser'));

                if (userData && userData.fullName && userData.id) {
                    userFullName = userData.fullName;
                    userId = userData.id;
                } else {
                    // No valid user data, redirect to login
                    window.location.href = 'log.html';
                    return; // Stop script execution
                }
            } catch (error) {
                console.error('Error parsing user data, redirecting to login.', error);
                window.location.href = 'log.html';
                return; // Stop script execution
            }

            // Set names
            document.getElementById('user-name').textContent = userFullName;

            // --- 4. Logout Logic (Copied from Dashboard) ---
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('myRtoUser');
                window.location.href = 'log.html';
            });

            // --- 5. Accordion Logic (Copied from Dashboard) ---
            const serviceDropdowns = document.querySelectorAll('details.group > div.pl-9 > details');

            serviceDropdowns.forEach(dropdown => {
                dropdown.addEventListener('toggle', (event) => {
                    if (dropdown.open) {
                        // Close other open dropdowns at the same level
                        serviceDropdowns.forEach(otherDropdown => {
                            if (otherDropdown !== dropdown && otherDropdown.open) {
                                otherDropdown.open = false;
                            }
                        });
                    }
                });
            });

            // --- 6. Auto-open parent dropdowns (Copied from Dashboard) ---
            const activeLink = document.querySelector('nav a[aria-current="page"]');
            if (activeLink) {
                let parent = activeLink.closest('details');
                while (parent) {
                    parent.open = true;
                    parent = parent.parentElement.closest('details');
                }
            }
            
            // --- 7. NEW: Event Listeners (Vehicle Page Specific) ---
            // Create a debounced version of our data fetch function
            const debouncedFetch = debounce(() => fetchVehicleData(userId), 300);

            // Call the debounced function on search input
            searchInput.addEventListener('input', debouncedFetch);

            // Call the fetch function directly on sort change
            sortSelect.addEventListener('change', () => fetchVehicleData(userId));

            // --- 8. Initial Data Fetch (Vehicle Page Specific) ---
            // Fetch data when the page first loads
            fetchVehicleData(userId);
        });

        // --- 9. NEW: Main Data Fetch Function ---
        async function fetchVehicleData(userId) {
            const searchTerm = searchInput.value;
            const sortBy = sortSelect.value;

            loadingMsg.textContent = "Loading your vehicle details...";
            loadingMsg.style.display = 'block';
            grid.innerHTML = ""; // Clear old results

            try {
                const url = new URL(`http://localhost:3000/api/vehicles/user/${userId}/vehicles`);
                url.searchParams.append('search', searchTerm);
                url.searchParams.append('sort', sortBy);

                const response = await fetch(url.toString());

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const vehicles = await response.json(); 
                
                // --- 10. Call Render Logic ---
                renderVehicles(vehicles);

            } catch (error) {
                console.error("Failed to fetch vehicles:", error);
                loadingMsg.textContent = "Error loading vehicle data. Please try again later.";
                loadingMsg.style.color = "red";
            }
        }

        // --- 11. NEW: "Render" Function ---
        function renderVehicles(vehiclesToDisplay) {
            
            // --- A. Handle No Results ---
            if (vehiclesToDisplay.length === 0) {
                if (searchInput.value) { // Check if they were searching
                    loadingMsg.textContent = "No vehicles match your search.";
                } else { // Or if they just have no vehicles
                    loadingMsg.textContent = "You do not have any vehicles registered.";
                }
                loadingMsg.style.display = 'block';
            } else {
                // We have results, hide the loading message
                loadingMsg.style.display = 'none';
            }

            // --- B. Call the Populate Function ---
            populateVehicleGrid(vehiclesToDisplay);
        }


        // --- 12. Populates the HTML grid with data ---
        function populateVehicleGrid(vehicles) {
            // grid.innerHTML is already cleared in fetchVehicleData

            vehicles.forEach(vehicle => {
                const card = document.createElement("div");
                card.className = "bg-white rounded-2xl shadow-lg overflow-hidden transition-all hover:shadow-xl";

                // Helper functions for formatting
                const regValid = formatDate(vehicle.registration_valid_upto);
                const insValid = formatDate(vehicle.insurance_end_date);
                const statusBadge = getStatusBadge(vehicle.application_status);
                const regDateClass = getDateClass(vehicle.registration_valid_upto);
                const insDateClass = getDateClass(vehicle.insurance_end_date);

                card.innerHTML = `
                    <div class="p-5 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-gray-800">${vehicle.registration_number || 'Pending'}</span>
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="p-5">
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Chassis No.</dt>
                                <dd class="mt-1 text-sm text-gray-900">${vehicle.chassis_number}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Financier (Lender)</dt>
                                <dd class="mt-1 text-sm text-gray-900">${vehicle.lender_name || 'None'}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Registration Valid Upto</dt>
                                <dd class="mt-1 text-sm font-medium ${regDateClass}">${regValid}</dd>
                            </div>
                            <div class="sm:col-span-1">
                                <dt class="text-sm font-medium text-gray-500">Insurance Valid Upto</dt>
                                <dd class="mt-1 text-sm font-medium ${insDateClass}">${insValid}</dd>
                            </div>
                        </dl>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 13. Helper Functions (Unchanged) ---

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function getStatusBadge(status) {
            if (status === 'Approved') {
                return `<span class="status status-approved">${status}</span>`;
            }
            if (status === 'Pend Inspection' || status === 'Submitted') {
                return `<span class="status status-pending">${status}</span>`;
            }
            if (status === 'Rejected') {
                return `<span class="status status-rejected">${status}</span>`;
            }
            return `<span class="status">${status || 'Draft'}</span>`;
        }

        function getDateClass(dateString) {
            if (!dateString) return '';
            const today = new Date();
            const expiryDate = new Date(dateString);
            today.setHours(0, 0, 0, 0);

            return expiryDate < today ? 'validity-expired' : 'validity-active';
        }
    </script>
</body>

</html>