<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Registration - MyRTO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Logo styles from your dashboard.html */
        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            height: 32px;
            width: 32px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .logo-text {
            color: white;
            font-size: 1.75rem;
            font-weight: 700;
        }

        /* --- STYLES ADDED FROM DASHBOARD --- */
        /* Smooth Dropdown Animation */
        .dropdown-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out, margin-top 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            margin-top: 0 !important;
        }

        details[open]>.dropdown-content {
            max-height: 400px;
            /* Adjust as needed */
            opacity: 1;
            margin-top: 0.25rem !important;
            /* Tailwind 'mt-1' */
        }
        
        /* --- Styles for this form page --- */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            border: 2px solid #d1d5db;
            /* gray-300 */
            color: #6b7280;
            /* gray-500 */
            font-weight: 500;
        }

        .step-indicator-active {
            border-color: #2563eb;
            /* blue-600 */
            background-color: #2563eb;
            color: white;
        }

        .step-indicator-complete {
            border-color: #22c55e;
            /* green-500 */
            background-color: #22c55e;
            color: white;
        }

        .step-line {
            width: 100%;
            height: 2px;
            background-color: #d1d5db;
            /* gray-300 */
        }

        .step-line-complete {
            background-color: #22c55e;
            /* green-500 */
        }

        /* Hide form steps by default */
        .form-step {
            display: none;
        }

        .form-step-active {
            display: block;
        }
    </style>
</head>

<body class="h-full">

    <div class="flex h-screen">

        <aside class="w-64 flex flex-col bg-indigo-800 text-indigo-100 shadow-xl">
            <div class="p-6">
                <div class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                        </path>
                    </svg>
                    <span class="logo-text">MyRTO</span>
                </div>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="dashboard.html"
                    class="flex items-center space-x-3 px-3 py-2 rounded-lg text-indigo-200 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                    </svg>
                    <span class="font-medium">Dashboard</span>
                </a>

                <details class="group" open>
                    <summary
                        class="flex items-center justify-between space-x-3 px-3 py-2 rounded-lg hover:bg-indigo-700 cursor-pointer transition-colors duration-200">
                        <div class="flex items-center space-x-3">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="font-medium">Services</span>
                        </div>
                        <svg class="h-5 w-5 transform group-open:rotate-90 transition-transform duration-200"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </summary>

                    <div class="mt-2 space-y-1 pl-9">
                        <details>
                            <summary
                                class="flex items-center justify-between px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white cursor-pointer transition-colors duration-200">
                                <span>License Services</span>
                                <svg class="h-5 w-5 transform open:rotate-90 transition-transform duration-200"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                </svg>
                            </summary>
                            <div class="mt-1 space-y-1 pl-4 dropdown-content">
                                <a href="llform.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Apply
                                    for learner's license</a>
                                <a href="profile.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Check
                                    Licence status</a>
                            </div>
                        </details>

                        <details open>
                            <summary
                                class="flex items-center justify-between px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white cursor-pointer transition-colors duration-200">
                                <span>Vehicle Services</span>
                                <svg class="h-5 w-5 transform open:rotate-90 transition-transform duration-200"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                </svg>
                            </summary>
                            <div class="mt-1 space-y-1 pl-4 dropdown-content">
                                <a href="vehiclereg.html"
                                    class="block px-3 py-2 rounded-md text-white bg-indigo-700 transition-colors duration-200 text-sm font-medium"
                                    aria-current="page">New
                                    vehicle registration</a>
                                <a href="renewal.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Renewal
                                    of registration</a>
                                <a href="transfer.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Transfer
                                    of ownership</a>
                                <a href="my_vehicles.html"
                                    class="block px-3 py-2 rounded-md text-indigo-200 hover:bg-indigo-700 hover:text-white transition-colors duration-200 text-sm">Check
                                    vehicle details</a>
                            </div>
                        </details>
                    </div>
                </details>

                <a href="dashboard.html#applications"
                    class="flex items-center space-x-3 px-3 py-2 rounded-lg text-indigo-200 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
                    </svg>
                    <span class="font-medium">My Applications</span>
                </a>
                <a href="my_payments.html"
                    class="flex items-center space-x-3 px-3 py-2 rounded-lg text-indigo-200 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                    <span class="font-medium">My Payments</span>
                </a>
            </nav>

            <div class="mt-auto p-4">
                <div class="flex items-center justify-between p-3 bg-indigo-700 rounded-lg">
                    <div>
                        <p class="text-sm">Welcome,</p>
                        <p id="user-name" class="font-medium text-white">User</p>
                    </div>
                    <button id="logout-button"
                        class="p-2 rounded-md text-indigo-200 hover:bg-red-500 hover:text-white transition-all duration-300 ease-in-out"
                        title="Log Out">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <div class="max-w-5xl mx-auto py-10 sm:px-6 lg:px-8">

                <div id="form-container" class="w-full bg-white rounded-2xl shadow-lg">

                    <div class="p-6 sm:p-8 border-b border-gray-200">
                        <h1 class="text-3xl font-bold text-gray-900">New Vehicle Registration</h1>
                        <div class="flex items-center justify-between mt-6 max-w-2xl mx-auto">
                            <div class="flex-1 flex flex-col items-center">
                                <div class="step-indicator step-indicator-active" id="step-ind-1">1</div>
                                <p class="text-xs mt-1 text-gray-500 font-medium">Owner</p>
                            </div>
                            <div class="step-line" id="step-line-1"></div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="step-indicator" id="step-ind-2">2</div>
                                <p class="text-xs mt-1 text-gray-500">Vehicle</p>
                            </div>
                            <div class="step-line" id="step-line-2"></div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="step-indicator" id="step-ind-3">3</div>
                                <p class="text-xs mt-1 text-gray-500">Purchase</p>
                            </div>
                            <div class="step-line" id="step-line-3"></div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="step-indicator" id="step-ind-4">4</div>
                                <p class="text-xs mt-1 text-gray-500">Insurance</p>
                            </div>
                            <div class="step-line" id="step-line-4"></div>
                            <div class="flex-1 flex flex-col items-center">
                                <div class="step-indicator" id="step-ind-5">5</div>
                                <p class="text-xs mt-1 text-gray-500">Payment</p>
                            </div>
                        </div>
                    </div>

                    <form id="new-vehicle-form" class="p-6 sm:p-8">
                        <div id="form-error-message"
                            class="hidden p-4 mb-4 bg-red-50 text-red-700 border border-red-200 rounded-lg"></div>

                        <div id="step-1" class="form-step form-step-active space-y-5">
                            <h2 class="text-xl font-semibold text-gray-900">Step 1: Owner Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <p id="full_name"
                                        class="mt-1 text-lg font-medium text-gray-800 p-3 bg-gray-100 rounded-md"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">PAN Number</label>
                                    <p id="pan_number"
                                        class="mt-1 text-lg font-medium text-gray-800 p-3 bg-gray-100 rounded-md"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email Address</label>
                                    <p id="email"
                                        class="mt-1 text-lg font-medium text-gray-800 p-3 bg-gray-100 rounded-md"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                                    <p id="phone_number"
                                        class="mt-1 text-lg font-medium text-gray-800 p-3 bg-gray-100 rounded-md"></p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Registered Address</label>
                                    <p id="address_display"
                                        class="mt-1 text-lg font-medium text-gray-800 p-3 bg-gray-100 rounded-md"></p>
                                </div>
                            </div>
                        </div>

                        <div id="step-2" class="form-step space-y-6">
                            <h2 class="text-xl font-semibold text-gray-900">Step 2: Vehicle Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="chassis_number" class="block text-sm font-medium text-gray-700">Chassis
                                        Number (VIN) <span class="text-red-500">*</span></label>
                                    <input type="text" id="chassis_number" name="chassis_number" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="engine_number" class="block text-sm font-medium text-gray-700">Engine
                                        Number <span class="text-red-500">*</span></label>
                                    <input type="text" id="engine_number" name="engine_number" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="model" class="block text-sm font-medium text-gray-700">Model (e.g.,
                                        Nexon) <span class="text-red-500">*</span></label>
                                    <input type="text" id="model" name="model" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="vehicle_class" class="block text-sm font-medium text-gray-700">Vehicle
                                        Class <span class="text-red-500">*</span></label>
                                    <select id="vehicle_class" name="vehicle_class" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Class...</option>
                                        <option value="LMV-NT">LMV (Car, Jeep)</option>
                                        <option value="MCWG">Motorcycle</option>
                                        <option value="HMV">Heavy Vehicle</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="fuel_type" class="block text-sm font-medium text-gray-700">Fuel Type
                                        <span class="text-red-500">*</span></label>
                                    <select id="fuel_type" name="fuel_type" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Fuel...</option>
                                        <option value="Petrol">Petrol</option>
                                        <option value="Diesel">Diesel</option>
                                        <option value="Electric">Electric</option>
                                        <option value="CNG">CNG</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="step-3" class="form-step space-y-6">
                            <h2 class="text-xl font-semibold text-gray-900">Step 3: Purchase & RTO Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="dealer_name" class="block text-sm font-medium text-gray-700">Dealer Name
                                        <span class="text-red-500">*</span></label>
                                    <input type="text" id="dealer_name" name="dealer_name" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="purchase_date" class="block text-sm font-medium text-gray-700">Purchase
                                        Date <span class="text-red-500">*</span></label>
                                    <input type="date" id="purchase_date" name="purchase_date" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="ex_showroom_price"
                                        class="block text-sm font-medium text-gray-700">Ex-Showroom Price (₹) <span
                                            class="text-red-500">*</span></label>
                                    <input type="number" id="ex_showroom_price" name="ex_showroom_price" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Road Tax (Auto
                                        Calculated)</label>
                                    <input type="number" id="road_tax" name="road_tax" readonly
                                        class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg shadow-sm">
                                </div>

                                <div>
                                    <label for="rto_office_code" class="block text-sm font-medium text-gray-700">RTO
                                        Office <span class="text-red-500">*</span></label>
                                    <select id="rto_office_code" name="rto_office_code" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select RTO...</option>
                                        <option value="GA03">GA03 - Mapusa</option>
                                        <option value="GA04">GA04 - Bicholim</option>
                                        <option value="GA05">GA05 - Ponda</option>
                                        <option value="GA06">GA06 - Vasco</option>
                                        <option value="GA07">GA07 - Panjim</option>
                                        <option value="GA08">GA08 - Margao</option>
                                        <option value="GA09">GA09 - Quepem</option>
                                        <option value="GA10">GA10 - Canacona</option>
                                        <option value="GA11">GA11 - Pernem</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="step-4" class="form-step space-y-6">
                            <h2 class="text-xl font-semibold text-gray-900">Step 4: Insurance Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="company_name" class="block text-sm font-medium text-gray-700">Insurance
                                        Company <span class="text-red-500">*</span></label>
                                    <input type="text" id="company_name" name="company_name" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="policy_number" class="block text-sm font-medium text-gray-700">Policy
                                        Number <span class="text-red-500">*</span></label>
                                    <input type="text" id="policy_number" name="policy_number" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="policy_type" class="block text-sm font-medium text-gray-700">Policy Type
                                        <span class="text-red-500">*</span></label>
                                    <select id="policy_type" name="policy_type" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Comprehensive">Comprehensive</option>
                                        <option value="Third Party">Third Party</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="start_date" class="block text-sm font-medium text-gray-700">Policy Start
                                        Date <span class="text-red-500">*</span></label>
                                    <input type="date" id="start_date" name="start_date" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="end_date" class="block text-sm font-medium text-gray-700">Policy End
                                        Date <span class="text-red-500">*</span></label>
                                    <input type="date" id="end_date" name="end_date" required
                                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>

                        <div id="step-5" class="form-step space-y-6">
                            <h2 class="text-xl font-semibold text-gray-900">Step 5: Complete Payment</h2>
                            <p class="text-gray-600">Your application is ready. Please pay the one-time road tax to
                                complete your registration.</p>

                            <div class="mt-6 p-6 bg-indigo-50 rounded-lg">
                                <div class="flex justify-between items-center text-sm text-gray-600">
                                    <span>Payment For</span>
                                    <span class="font-medium text-gray-900">Road Tax (New Registration)</span>
                                </div>
                                <div class="flex justify-between items-center mt-4 pt-4 border-t border-indigo-200">
                                    <span class="text-lg font-medium text-gray-900">Total Amount Due</span>
                                    <span id="payment-amount-display"
                                        class="text-3xl font-bold text-indigo-700">₹--.--</span>
                                </div>
                            </div>
                        </div>


                        <div class="pt-6 border-t border-gray-200 mt-8">
                            <div class="flex justify-between">
                                <button type="button" id="prev-step-btn"
                                    class="bg-white py-3 px-6 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    Back
                                </button>
                                <button type="button" id="next-step-btn"
                                    class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700">
                                    Next
                                </button>
                            </div>
                        </div>

                    </form>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- REPLACED: User & Auth (from your dashboard/my_vehicles.html) ---
            let userFullName = 'User';
            let userId = null;
            let userData = null;

            try {
                userData = JSON.parse(localStorage.getItem('myRtoUser'));

                if (userData && userData.fullName && userData.id) {
                    userFullName = userData.fullName;
                    userId = userData.id; // This userId is now available to the whole script
                } else {
                    // No valid user data, redirect to login
                    window.location.href = 'log.html';
                    return; // Stop script execution
                }
            } catch (error) {
                console.error('Error parsing user data, redirecting to login.', error);
                window.location.href = 'log.html';
                return; // Stop script execution
            }

            // Set user name in sidebar
            document.getElementById('user-name').textContent = userFullName;


            // --- REPLACED: Logout Logic (from your dashboard/my_vehicles.html) ---
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('myRtoUser');
                window.location.href = 'log.html';
            });

            // --- ADDED: Accordion Logic (from dashboard) ---
            const serviceDropdowns = document.querySelectorAll('details.group > div.pl-9 > details');

            serviceDropdowns.forEach(dropdown => {
                dropdown.addEventListener('toggle', (event) => {
                    if (dropdown.open) {
                        // Close other open dropdowns at the same level
                        serviceDropdowns.forEach(otherDropdown => {
                            if (otherDropdown !== dropdown && otherDropdown.open) {
                                otherDropdown.open = false;
                            }
                        });
                    }
                });
            });

            // --- ADDED: Auto-open parent dropdowns (from dashboard) ---
            const activeLink = document.querySelector('nav a[aria-current="page"]');
            if (activeLink) {
                let parent = activeLink.closest('details');
                while (parent) {
                    parent.open = true;
                    parent = parent.parentElement.closest('details');
                }
            }

            // --- Form Wizard State (Original to this page) ---
            let currentStep = 1;
            const totalSteps = 5; // CHANGED from 6 to 5
            const form = document.getElementById('new-vehicle-form');
            const steps = document.querySelectorAll('.form-step');
            const prevBtn = document.getElementById('prev-step-btn');
            const nextBtn = document.getElementById('next-step-btn');
            const indicators = document.querySelectorAll('.step-indicator');
            const lines = document.querySelectorAll('.step-line');
            const errorMessage = document.getElementById('form-error-message');
            const formContainer = document.getElementById('form-container');
            const roadTaxInput = document.getElementById('road_tax');
            const priceInput = document.getElementById('ex_showroom_price');

            // --- Function to Fetch and Prefill User Data ---
            async function fetchAndPrefillData() {
                try {
                    // 'userId' is available here from the auth block above
                    const response = await fetch(`http://localhost:3000/api/vehicles/user/${userId}`);
                    if (!response.ok) throw new Error('Could not fetch user data.');
                    const user = await response.json();
                    document.getElementById('full_name').textContent = user.full_name;
                    document.getElementById('pan_number').textContent = user.pan_number;
                    document.getElementById('email').textContent = user.email;
                    document.getElementById('phone_number').textContent = user.phone_number;
                    document.getElementById('address_display').textContent = `${user.address_line1}, ${user.city}, ${user.state} - ${user.pincode}`;
                } catch (error) {
                    console.error('Error prefilling data:', error);
                    errorMessage.textContent = 'Could not load your user details. Please try refreshing.';
                    errorMessage.classList.remove('hidden');
                }
            }

            // --- Function to show a specific step ---
            function showStep(stepNumber) {
                steps.forEach(step => step.classList.remove('form-step-active'));
                document.getElementById(`step-${stepNumber}`).classList.add('form-step-active');

                // Logic for Payment Step (Now Step 5)
                if (stepNumber === 5) {
                    const roadTax = parseFloat(roadTaxInput.value || 0).toFixed(2);
                    document.getElementById('payment-amount-display').textContent = `₹${roadTax}`;
                }

                indicators.forEach((ind, index) => {
                    ind.classList.remove('step-indicator-active', 'step-indicator-complete');
                    if (index + 1 < stepNumber) {
                        ind.classList.add('step-indicator-complete');
                    } else if (index + 1 === stepNumber) {
                        ind.classList.add('step-indicator-active');
                    }
                });

                lines.forEach((line, index) => {
                    line.classList.remove('step-line-complete');
                    if (index < stepNumber - 1) {
                        line.classList.add('step-line-complete');
                    }
                });

                // Button Text and Style Logic
                prevBtn.style.display = (stepNumber === 1) ? 'none' : 'inline-flex';
                
                nextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-600', 'hover:bg-green-700');

                if (stepNumber === totalSteps) {
                    nextBtn.textContent = 'Pay & Submit Application';
                    nextBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else if (stepNumber === totalSteps - 1) {
                    nextBtn.textContent = 'Next: Review & Pay';
                    nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    nextBtn.textContent = 'Next';
                    nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            }

            // --- Function to validate the current step ---
            function validateStep(stepNumber) {
                let isValid = true;
                const currentStepEl = document.getElementById(`step-${stepNumber}`);
                const inputs = currentStepEl.querySelectorAll('input[required], select[required]');

                inputs.forEach(input => {
                    if (input.offsetParent !== null && !input.value.trim()) {
                        isValid = false;
                        input.classList.add('border-red-500', 'ring-red-500');
                    } else {
                        input.classList.remove('border-red-500', 'ring-red-500');
                    }
                });

                if (!isValid) {
                    errorMessage.textContent = 'Please fill out all required fields marked with *';
                    errorMessage.classList.remove('hidden');
                } else {
                    errorMessage.classList.add('hidden');
                }
                return isValid;
            }

            // --- Function to handle form submission ---
            async function submitForm() {
                nextBtn.disabled = true;
                nextBtn.textContent = 'Submitting...';
                errorMessage.classList.add('hidden'); // Hide old errors

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.owner_id = userId; // 'userId' is from the auth block
                // Removed data.on_loan assignment

                let regResult; // To store registration result
                try {
                    // --- PART 1: Register Application (creates pending payment) ---
                    const response = await fetch('http://localhost:3000/api/vehicles/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    regResult = await response.json();
                    if (!response.ok) {
                        throw new Error(regResult.message || 'An error occurred during registration.');
                    }
                    
                    // --- PART 2: Complete Payment (Demo) ---
                    nextBtn.textContent = 'Processing Payment...';
                    const paymentId = regResult.payment_id;
                    const regNumber = regResult.registration_number;

                    const paymentResponse = await fetch(`http://localhost:3000/api/payments/${paymentId}/complete`, {
                        method: 'POST'
                    });
                    
                    const paymentResult = await paymentResponse.json();
                    if (!paymentResponse.ok) {
                        throw new Error(paymentResult.message || 'Payment failed. Your application is saved but unpaid.');
                    }

                    // --- PART 3: Show Final Success ---
                    const finalSuccessHTML = `
                    <div class="p-6 sm:p-8 text-center">
                        <svg class="h-16 w-16 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-2xl font-bold text-gray-900 mt-4">Payment Successful!</h2>
                        <p class="text-lg text-gray-600 mt-2">Your application is complete and is now being processed.</p>
                        
                        <div class="mt-6 p-4 bg-gray-50 text-gray-800 border border-gray-200 rounded-lg inline-block">
                            <p class="text-sm">Temporary Registration No:</p>
                            <p class="text-2xl font-bold">${regNumber}</p>
                            <p class="text-sm mt-2">Transaction ID:</p>
                            <p class="text-lg font-bold">${paymentResult.transaction_id}</p>
                        </div>
                        
                        <div class="mt-8">
                            <a href="dashboard.html#applications" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700">
                                Go to My Applications
                            </a>
                        </div>
                    </div>
                    `;
                    formContainer.innerHTML = finalSuccessHTML;

                } catch (error) {
                    // Catch errors from *either* registration or payment
                    console.error('Form submission error:', error);
                    errorMessage.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                    nextBtn.disabled = false;
                    // Reset button to its Final Step state
                    nextBtn.textContent = 'Pay & Submit Application'; 
                }
            }

            // --- Event Listeners ---

            // Next Button
            nextBtn.addEventListener('click', () => {
                if (currentStep < totalSteps && !validateStep(currentStep)) {
                    return; // Stop if validation fails
                }
                
                if (currentStep === totalSteps) {
                    submitForm();
                } else {
                    currentStep++;
                    showStep(currentStep);
                }
            });

            // Previous Button
            prevBtn.addEventListener('click', () => {
                if(currentStep > 1) {
                    currentStep--;
                    nextBtn.textContent = (currentStep === totalSteps - 1) ? 'Next: Review & Pay' : 'Next';
                    nextBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    errorMessage.classList.add('hidden'); // Hide errors when going back
                    showStep(currentStep);
                }
            });

            // --- Initial Page Load ---
            fetchAndPrefillData();
            showStep(currentStep); // Show the first step

            // --- ROAD TAX CALCULATION ---
            if (priceInput) {
                priceInput.addEventListener('input', () => {
                    const price = parseFloat(priceInput.value) || 0;
                    const roadTax = price * 0.08;
                    roadTaxInput.value = roadTax.toFixed(2);
                });
            }
        });
    </script>
</body>

</html>